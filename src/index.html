<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Harita Görüntüleyici</title>
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.js'></script>
  <style>
    html,
    body,
    #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
    }

    .airplane-marker {
      width: 32px;
      height: 32px;
      transform: translate(-50%, -50%);
      will-change: transform;
      pointer-events: none;
      user-select: none;
      display: block;
    }

    .control-panel {
      position: absolute;
      top: 24px;
      right: 32px;
      z-index: 20;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 18px 22px 16px 22px;
      min-width: 200px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
    }

    .control-panel-title {
      font-size: 17px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #1976d2;
      letter-spacing: 1px;
    }

    .control-panel-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr 1fr;
      gap: 10px;
      width: 100%;
    }

    .control-panel button {
      padding: 7px 0;
      border: 1px solid #bbb;
      border-radius: 4px;
      background: #f7f7f7;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
      width: 90px;
      font-weight: 500;
    }

    .control-panel button.active {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }

    .control-panel button:active {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }

    .temperature-info {
      margin-top: 10px;
      font-size: 16px;
      font-weight: 600;
      color: #d32f2f;
      letter-spacing: 1px;
      text-align: center;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="control-panel">
    <div class="control-panel-title">Control Panel</div>
    <div class="control-panel-grid">
      <button id="startBtn">Start</button>
      <button id="stopBtn">Stop</button>
      <button id="continueBtn">Continue</button>
      <button id="restartBtn">Restart</button>
      <button id="speed1Btn" class="active">1x</button>
      <button id="speed2Btn">2x</button>
    </div>
    <div class="temperature-info">
      Sıcaklık: <span id="temperature-value">-</span>°C
    </div>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const map = new maplibregl.Map({
        container: 'map',
        style: 'http://127.0.0.1:8081/styles/osm-bright/style.json',
        center: [28.950, 41.000],
        zoom: 10
      });

      // Sıcaklık değerleri ve renkleri
      const temperatureSteps = [
        { value: 10, color: "#2196f3" }, // Mavi
        { value: 18, color: "#4caf50" }, // Yeşil
        { value: 24, color: "#ffeb3b" }, // Sarı
        { value: 30, color: "#ff9800" }, // Turuncu
        { value: 36, color: "#d32f2f" }  // Kırmızı
      ];

      // Her nokta için sıcaklıkları sırayla ata
      function getTemperatureForIndex(idx) {
        return temperatureSteps[idx % temperatureSteps.length];
      }

      const pathCoordinates = [
        [28.916, 41.038], [28.918, 41.040], [28.920, 41.042], [28.923, 41.041], [28.927, 41.039],
        [28.930, 41.037], [28.933, 41.035], [28.935, 41.033], [28.937, 41.031], [28.940, 41.029],
        [28.943, 41.027], [28.945, 41.025], [28.947, 41.023], [28.949, 41.024], [28.951, 41.026],
        [28.953, 41.028], [28.955, 41.030], [28.957, 41.032], [28.959, 41.034], [28.961, 41.036],
        [28.963, 41.038], [28.965, 41.040], [28.967, 41.042], [28.969, 41.041], [28.971, 41.039],
        [28.973, 41.037], [28.975, 41.035], [28.977, 41.033], [28.979, 41.031], [28.981, 41.029],
        [28.983, 41.031], [28.985, 41.033], [28.987, 41.035], [28.989, 41.037], [28.991, 41.039],
        [28.993, 41.041], [28.995, 41.043], [28.997, 41.042], [28.999, 41.040], [29.001, 41.038],
        [29.003, 41.036], [29.005, 41.034], [29.007, 41.032], [29.009, 41.030], [29.011, 41.028],
        [29.013, 41.026], [29.015, 41.024], [29.017, 41.022], [29.019, 41.020], [29.021, 41.018],
        [29.023, 41.019], [29.025, 41.021], [29.027, 41.023], [29.029, 41.025], [29.031, 41.027],
        [29.033, 41.029], [29.035, 41.031], [29.037, 41.033], [29.039, 41.035], [29.041, 41.033],
        [29.043, 41.031], [29.045, 41.029], [29.047, 41.028], [29.049, 41.027], [29.051, 41.026],
        [29.053, 41.025], [29.055, 41.024], [29.057, 41.023], [29.059, 41.022], [29.061, 41.021],
        [29.063, 41.020], [29.065, 41.019], [29.067, 41.018], [29.069, 41.017], [29.071, 41.016],
        [29.073, 41.015], [29.075, 41.014], [29.077, 41.015], [29.079, 41.016], [29.081, 41.017],
        [29.083, 41.018], [29.085, 41.019], [29.087, 41.020], [29.089, 41.021], [29.091, 41.022],
        [29.093, 41.023], [29.095, 41.024], [29.097, 41.025], [29.099, 41.026], [29.101, 41.027]
      ];
      const totalPoints = pathCoordinates.length;

      let marker, img;
      let currentIndex = 0;
      let segmentStart = null;
      let segmentBearing = 0;
      let animationFrameId = null;
      let isPaused = false;
      let pausedTimestamp = null;
      let passedCoords = [];
      let passedTemps = [];
      let speed = 1; // 1x veya 2x

      // Çoklu renkli çizgi için dinamik layer
      function updatePassedLine() {
        // Her segmenti ayrı bir Feature olarak çiz
        const features = [];
        for (let i = 1; i < passedCoords.length; i++) {
          features.push({
            type: 'Feature',
            geometry: {
              type: 'LineString',
              coordinates: [passedCoords[i - 1], passedCoords[i]]
            },
            properties: {
              color: getTemperatureForIndex(i - 1).color
            }
          });
        }
        map.getSource('passed-line').setData({
          type: 'FeatureCollection',
          features
        });
      }

      // Layer'ı çoklu renkli çizgiye uygun hale getir
      function addPassedLineLayer() {
        map.addSource('passed-line', {
          type: 'geojson',
          data: {
            type: 'FeatureCollection',
            features: []
          }
        });
        map.addLayer({
          id: 'passed-line-layer',
          type: 'line',
          source: 'passed-line',
          layout: {
            'line-cap': 'round',
            'line-join': 'round'
          },
          paint: {
            'line-width': 4,
            'line-color': [
              'case',
              ['has', 'color'],
              ['get', 'color'],
              '#d32f2f'
            ]
          }
        });
      }

      map.on('load', () => {
        addPassedLineLayer();

        // Marker için img oluştur
        img = document.createElement("img");
        img.src = './airplane.png';
        img.className = 'airplane-marker';

        // Marker'ı oluştur
        marker = new maplibregl.Marker({
          element: img,
          rotationAlignment: 'map'
        })
          .setLngLat(pathCoordinates[0])
          .addTo(map);

        // Bearing hesaplama
        function computeBearing(start, end) {
          const toRad = deg => deg * Math.PI / 180;
          const toDeg = rad => rad * 180 / Math.PI;
          const [lng1, lat1] = start.map(toRad);
          const [lng2, lat2] = end.map(toRad);
          const dLng = lng2 - lng1;
          const y = Math.sin(dLng) * Math.cos(lat2);
          const x =
            Math.cos(lat1) * Math.sin(lat2) -
            Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
          let brng = Math.atan2(y, x);
          brng = toDeg(brng);
          return (brng + 360) % 360;
        }

        // Lineer interpolasyon
        function interpolateLatLng(start, end, t) {
          const lat = start[1] + (end[1] - start[1]) * t;
          const lng = start[0] + (end[0] - start[0]) * t;
          return [lng, lat];
        }

        function updateTemperatureInfo(idx) {
          const tempObj = getTemperatureForIndex(idx);
          document.getElementById('temperature-value').innerText = tempObj.value;
          document.getElementById('temperature-value').style.color = tempObj.color;
        }

        function resetMarker() {
          currentIndex = 0;
          segmentStart = null;
          segmentBearing = 0;
          passedCoords = [pathCoordinates[0]];
          passedTemps = [getTemperatureForIndex(0)];
          marker.setLngLat(pathCoordinates[0]);
          marker.setRotation(computeBearing(pathCoordinates[0], pathCoordinates[1]) - 90);
          updatePassedLine();
          updateTemperatureInfo(0);
        }

        function animateStep(timestamp) {
          if (isPaused) {
            pausedTimestamp = timestamp;
            return;
          }
          if (segmentStart === null) {
            segmentStart = timestamp;
            // Sadece segment başında bearing hesapla
            if (currentIndex < totalPoints - 1) {
              segmentBearing = computeBearing(
                pathCoordinates[currentIndex],
                pathCoordinates[currentIndex + 1]
              );
              marker.setRotation(segmentBearing - 90);
              updateTemperatureInfo(currentIndex);
            }
          }
          const segmentDuration = 800 / speed;
          const elapsed = timestamp - segmentStart;
          const t = Math.min(elapsed / segmentDuration, 1);

          if (currentIndex >= totalPoints - 1) {
            animationFrameId = null;
            return;
          }

          const from = pathCoordinates[currentIndex];
          const to = pathCoordinates[currentIndex + 1];

          const [lng, lat] = interpolateLatLng(from, to, t);
          marker.setLngLat([lng, lat]);

          // Geçilen noktayı çizgiye ekle
          if (t === 1) {
            passedCoords.push([lng, lat]);
            passedTemps.push(getTemperatureForIndex(currentIndex + 1));
            updatePassedLine();
          } else if (passedCoords.length === 1) {
            updatePassedLine();
          }

          if (t < 1) {
            animationFrameId = requestAnimationFrame(animateStep);
          } else {
            currentIndex++;
            segmentStart = null;
            animationFrameId = requestAnimationFrame(animateStep);
          }
        }

        // Buton işlevleri
        function setSpeed(newSpeed) {
          speed = newSpeed;
          document.getElementById('speed1Btn').classList.toggle('active', speed === 1);
          document.getElementById('speed2Btn').classList.toggle('active', speed === 2);
        }

        document.getElementById('startBtn').onclick = function () {
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          setSpeed(1);
          resetMarker();
          isPaused = false;
          animationFrameId = requestAnimationFrame(animateStep);
        };

        document.getElementById('stopBtn').onclick = function () {
          isPaused = true;
        };

        document.getElementById('continueBtn').onclick = function () {
          if (!isPaused) return;
          isPaused = false;
          if (pausedTimestamp !== null) {
            segmentStart += performance.now() - pausedTimestamp;
            pausedTimestamp = null;
          }
          animationFrameId = requestAnimationFrame(animateStep);
        };

        document.getElementById('restartBtn').onclick = function () {
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          setSpeed(1);
          resetMarker();
          isPaused = false;
          animationFrameId = requestAnimationFrame(animateStep);
        };

        document.getElementById('speed1Btn').onclick = function () {
          setSpeed(1);
        };
        document.getElementById('speed2Btn').onclick = function () {
          setSpeed(2);
        };

        // Başlangıçta marker'ı sıfırla
        setSpeed(1);
        resetMarker();
      });
    });
  </script>
</body>

</html>