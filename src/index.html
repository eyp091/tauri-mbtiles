<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Harita Görüntüleyici</title>

  <link href="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.css" rel="stylesheet">
  <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.css"
    type="text/css">
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.js'></script>
  <style>
    html,
    body,
    #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
    }

    .toolbar {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 30;
      background: rgba(255, 255, 255, 0.97);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 12px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-width: 180px;
      user-select: none;
    }

    .toolbar h3 {
      margin: 0 0 8px 0;
      font-size: 16px;
      color: #333;
      font-weight: 600;
    }

    .toolbar button,
    .toolbar select {
      padding: 6px 12px;
      border: 1px solid #bbb;
      border-radius: 4px;
      background: #f7f7f7;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toolbar button.active {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }

    .toolbar button:hover:not(.active) {
      background: #e3e3e3;
    }

    .measure-result {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.97);
      padding: 10px 18px;
      border-radius: 6px;
      font-size: 15px;
      z-index: 40;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      min-width: 160px;
      text-align: center;
      display: none;
      pointer-events: none;
    }

    .marker-remove-btn {
      background: #d32f2f;
      color: #fff;
      border: none;
      border-radius: 3px;
      padding: 2px 8px;
      font-size: 12px;
      cursor: pointer;
      margin-left: 8px;
    }

    .maplibregl-canvas {
      cursor: default !important;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="toolbar" id="toolbar">
    <h3>Harita Araçları</h3>
    <button id="marker-btn">Marker Ekle</button>
    <button id="draw-line-btn">Çizgi Ölç</button>
    <button id="draw-polygon-btn">Alan Ölç</button>
    <button id="draw-point-btn">Nokta Çiz</button>
    <button id="draw-trash-btn">Çizimleri Temizle</button>
  </div>
  <div id="measure-result" class="measure-result"></div>

  <script src="https://api.mapbox.com/mapbox-gl-js/v3.12.0/mapbox-gl.js"></script>
  <script>
    window.mapboxgl = maplibregl;
  </script>
  <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.5.0/mapbox-gl-draw.js"></script>
  <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      // Harita başlat
      const map = new maplibregl.Map({
        container: 'map',
        style: 'http://127.0.0.1:8081/styles/osm-bright/style.json',
        center: [28.950, 41.000],
        zoom: 10
      });

      map.on('load', () => {
        map.loadImage('./airplane.png', (error, image) => {
          if (error) {
            console.error('Airplane image yüklenemedi:', error);
            return;
          }
          map.addImage('airplane-icon', image);

          initializePlaneLayer();
          animatePlaneAlongPath();
        });
      });

      // #region Marker animasyonu
      const pathCoordinates = [
        // 1. Avrupa yakası – Hasköy (Eyüp) çevresi
        [28.916, 41.038],
        [28.918, 41.040],
        [28.920, 41.042],
        // 2. Aşağı doğru – Balat yönüne meyilli (Golden Horn boyunca)
        [28.923, 41.041],
        [28.927, 41.039],
        [28.930, 41.037],
        [28.933, 41.035],
        // 3. Tekrar yukarı – Karaköy/Beyoğlu hattına doğru
        [28.937, 41.037],
        [28.940, 41.039],
        [28.943, 41.042],
        // 4. Boğaza yaklaşırken ufak bir sol dönüş
        [28.948, 41.044],
        [28.952, 41.046],
        // 5. Boğazı geçme bölgesi – Galata Köprüsü yönü
        [28.958, 41.048],
        [28.963, 41.049],
        [28.968, 41.050],
        // 6. Asya’ya geçerken kısa bir batıya yönelme (Üsküdar’a inerken)
        [28.974, 41.052],
        [28.980, 41.054],
        // 7. Tekrar kuzeye dönerek Beylerbeyi yönüne sapma
        [28.986, 41.056],
        [28.990, 41.058],
        [28.994, 41.059],
        // 8. Hemen ardından güneye doğru – Kuzguncuk sınırı
        [28.997, 41.056],
        [28.999, 41.054],
        // 9. Çengelköy’e meyilli küçük bir kuzey yönelme
        [29.002, 41.057],
        [29.006, 41.059],
        // 10. Çengelköy’den geri dönerek Üsküdar merkez
        [29.009, 41.056],
        [29.012, 41.054],
        [29.015, 41.052],
        // 11. Kadıköy’e doğru son dönüşler
        [29.019, 41.055],
        [29.023, 41.058],
        [29.027, 41.060],
        [29.030, 41.062],
        // 12. Son olarak Kurtuluş/Kadıköy civarı
        [29.034, 41.061],
        [29.038, 41.059]
      ];

      let currentIndex = 0;
      const totalPoints = pathCoordinates.length;

      const img = document.createElement("img");
      img.src = './airplane.png';
      img.style.width = '32px';
      img.style.height = '32px';
      img.style.transformOrigin = '50% 50%';
      img.style.transform = 'translate(-50%, -50%)';
      img.style.cursor = 'pointer';

      const marker = new maplibregl.Marker({ element: img })
        .setLngLat(pathCoordinates[0])
        .addTo(map);

      function computeBearing(start, end) {
        const [lng1, lat1] = start.map((d) => (d * Math.PI) / 180);
        const [lng2, lat2] = end.map((d) => (d * Math.PI) / 180);
        const dLng = lng2 - lng1;
        const y = Math.sin(dLng) * Math.cos(lat2);
        const x =
          Math.cos(lat1) * Math.sin(lat2) -
          Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
        let brng = Math.atan2(y, x);
        brng = (brng * 180) / Math.PI;
        return (brng + 360) % 360;
      }

      function animateSegment(from, to, durationMs, onComplete) {
        const startTime = performance.now();
        const [lng1, lat1] = from;
        const [lng2, lat2] = to;

        const bearing = computeBearing(from, to);
        img.style.transform = 'translate(-50%, -50%) rotate(' + bearing.toFixed(1) + 'deg)';

        function frame(now) {
          const elapsed = now - startTime;
          const t = Math.min(elapsed / durationMs, 1); // 0 ≤ t ≤ 1

          const currentLng = lng1 + (lng2 - lng1) * t;
          const currentLat = lat1 + (lat2 - lat1) * t;

          marker.setLngLat([currentLng, currentLat]);

          if (t < 1) {
            requestAnimationFrame(frame);
          } else {
            if (typeof onComplete === 'function') {
              onComplete();
            }
          }
        }
        requestAnimationFrame(frame);
      }

      function animateToNext() {
        if (currentIndex + 1 >= totalPoints) {
          return; // Bitti
        }
        const from = pathCoordinates[currentIndex];
        const to = pathCoordinates[currentIndex + 1];

        animateSegment(from, to, 800, () => {
          currentIndex++;
          animateToNext();
        });
      }
      animateToNext();

      // #endregion

      map.on('load', () => {
        // Araç çubuğu ve ölçüm kutusu görünür olsun
        document.getElementById('toolbar').style.display = 'flex';
        document.getElementById('measure-result').style.display = 'none';
      });
    });
  </script>
</body>

</html>