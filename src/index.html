<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Harita Görüntüleyici</title>
  <link rel='stylesheet' href='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.css' />
  <script src='https://unpkg.com/maplibre-gl@5.5.0/dist/maplibre-gl.js'></script>
  <style>
    html,
    body,
    #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100vh;
    }

    .airplane-marker {
      width: 32px;
      height: 32px;
      transform: translate(-50%, -50%);
      will-change: transform;
      pointer-events: none;
      user-select: none;
      display: block;
    }

    .controls {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 10;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      padding: 10px 20px;
      display: flex;
      gap: 10px;
    }

    .controls button {
      padding: 6px 16px;
      border: 1px solid #bbb;
      border-radius: 4px;
      background: #f7f7f7;
      font-size: 15px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .controls button:active {
      background: #1976d2;
      color: #fff;
      border-color: #1976d2;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div class="controls">
    <button id="startBtn">Start</button>
    <button id="stopBtn">Stop</button>
    <button id="continueBtn">Continue</button>
    <button id="restartBtn">Restart</button>
  </div>
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const map = new maplibregl.Map({
        container: 'map',
        style: 'http://127.0.0.1:8081/styles/osm-bright/style.json',
        center: [28.950, 41.000],
        zoom: 10
      });

      const pathCoordinates = [
        [28.916, 41.038], [28.918, 41.040], [28.920, 41.042], [28.923, 41.041], [28.927, 41.039],
        [28.930, 41.037], [28.933, 41.035], [28.937, 41.037], [28.940, 41.039], [28.943, 41.042],
        [28.948, 41.044], [28.952, 41.046], [28.958, 41.048], [28.963, 41.049], [28.968, 41.050],
        [28.974, 41.052], [28.980, 41.054], [28.986, 41.056], [28.990, 41.058], [28.994, 41.059],
        [28.997, 41.056], [28.999, 41.054], [29.002, 41.057], [29.006, 41.059], [29.009, 41.056],
        [29.012, 41.054], [29.015, 41.052], [29.019, 41.055], [29.023, 41.058], [29.027, 41.060],
        [29.030, 41.062], [29.034, 41.061], [29.038, 41.059]
      ];
      const totalPoints = pathCoordinates.length;

      let marker, img;
      let currentIndex = 0;
      let segmentStart = null;
      let segmentBearing = 0;
      let animationFrameId = null;
      let isPaused = false;
      let pausedTimestamp = null;

      map.on('load', () => {
        // Marker için img oluştur
        img = document.createElement("img");
        img.src = './airplane.png';
        img.className = 'airplane-marker';

        // Marker'ı oluştur
        marker = new maplibregl.Marker({
            element: img,
            rotationAlignment: 'map'
          })
          .setLngLat(pathCoordinates[0])
          .addTo(map);

        // Bearing hesaplama
        function computeBearing(start, end) {
          const toRad = deg => deg * Math.PI / 180;
          const toDeg = rad => rad * 180 / Math.PI;
          const [lng1, lat1] = start.map(toRad);
          const [lng2, lat2] = end.map(toRad);
          const dLng = lng2 - lng1;
          const y = Math.sin(dLng) * Math.cos(lat2);
          const x =
            Math.cos(lat1) * Math.sin(lat2) -
            Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLng);
          let brng = Math.atan2(y, x);
          brng = toDeg(brng);
          return (brng + 360) % 360;
        }

        // Lineer interpolasyon
        function interpolateLatLng(start, end, t) {
          const lat = start[1] + (end[1] - start[1]) * t;
          const lng = start[0] + (end[0] - start[0]) * t;
          return [lng, lat];
        }

        function resetMarker() {
          currentIndex = 0;
          segmentStart = null;
          segmentBearing = 0;
          marker.setLngLat(pathCoordinates[0]);
          marker.setRotation(computeBearing(pathCoordinates[0], pathCoordinates[1]) - 90);
        }

        function animateStep(timestamp) {
          if (isPaused) {
            pausedTimestamp = timestamp;
            return;
          }
          if (segmentStart === null) {
            segmentStart = timestamp;
            // Sadece segment başında bearing hesapla
            if (currentIndex < totalPoints - 1) {
              segmentBearing = computeBearing(
                pathCoordinates[currentIndex],
                pathCoordinates[currentIndex + 1]
              );
              marker.setRotation(segmentBearing - 90);
            }
          }
          const segmentDuration = 800;
          const elapsed = timestamp - segmentStart;
          const t = Math.min(elapsed / segmentDuration, 1);

          if (currentIndex >= totalPoints - 1) {
            animationFrameId = null;
            return;
          }

          const from = pathCoordinates[currentIndex];
          const to = pathCoordinates[currentIndex + 1];

          const [lng, lat] = interpolateLatLng(from, to, t);
          marker.setLngLat([lng, lat]);

          if (t < 1) {
            animationFrameId = requestAnimationFrame(animateStep);
          } else {
            currentIndex++;
            segmentStart = null;
            animationFrameId = requestAnimationFrame(animateStep);
          }
        }

        // Buton işlevleri
        document.getElementById('startBtn').onclick = function() {
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          resetMarker();
          isPaused = false;
          animationFrameId = requestAnimationFrame(animateStep);
        };

        document.getElementById('stopBtn').onclick = function() {
          isPaused = true;
        };

        document.getElementById('continueBtn').onclick = function() {
          if (!isPaused) return;
          isPaused = false;
          // segmentStart'ı pause edilen zamana göre ayarla
          if (pausedTimestamp !== null) {
            segmentStart += performance.now() - pausedTimestamp;
            pausedTimestamp = null;
          }
          animationFrameId = requestAnimationFrame(animateStep);
        };

        document.getElementById('restartBtn').onclick = function() {
          if (animationFrameId) cancelAnimationFrame(animationFrameId);
          resetMarker();
          isPaused = false;
          animationFrameId = requestAnimationFrame(animateStep);
        };

        // Başlangıçta marker'ı sıfırla
        resetMarker();
      });
    });
  </script>
</body>

</html>